window.addEventListener("load", (e) => {document.querySelector("#previous-examples1").onclick = prevPressed});
window.addEventListener("load", (e) => {document.querySelector("#previous-examples2").onclick = prevPressed});
window.addEventListener("load", (e) => {document.querySelector("#next-examples1").onclick = nextPressed});
window.addEventListener("load", (e) => {document.querySelector("#next-examples2").onclick = nextPressed});

let limit = 0;                  //# of example Pokémon that show up per page   
let currentPageOffset1 = 0;     //offset from 0 of type1's example list
let currentPageOffset2 = 0;     //offset from 0 of type2's example list
let resultsNum1 = 0;            //# of Pokémon of type1
let resultsNum2 = 0;            //# of Pokémon of type2
let isType1 = true;             //is the current list type1's list?
let examplePokemon1 = null;     //hold example Pokémon of type1
let examplePokemon2 = null;     //hold example Pokémon of type2
let generatePressed = true;     //was the generate button pressed?

//PURPOSE: Prepare to move to the previous list of pokémon in the examples
//ARGUMENTS: --
function prevPressed(){
    isFirstLoad = false;
    if(this.id == "previous-examples1"){
        let url = POKEAPI_URL + "type/" + type1;

        generatePressed = false;
        currentPageOffset1 -= limit;
        //prevent offset from going below 0
        if(currentPageOffset1 < 0){currentPageOffset1 = 0;}

        clearList(document.querySelector("#example-pokemon1"));
        getMatchupData(url);
    }
    else{
        let url = POKEAPI_URL + "type/" + type2;

        generatePressed = false;
        currentPageOffset2 -= limit;
        if(currentPageOffset2 < 0){currentPageOffset2 = 0;}

        clearList(document.querySelector("#example-pokemon2"));
        getMatchupData(url);
    }
}

//PURPOSE: Prepare to move to the next list of pokémon in the examples
//ARGUMENTS; --
function nextPressed(){
    isFirstLoad = false;

    if(this.id == "next-examples1"){
        let url = POKEAPI_URL + "type/" + type1;

        generatePressed = false;
        currentPageOffset1 += limit;
        //prevent offset from going over number of pokémon
        if(currentPageOffset1 >= examplePokemon1.length){currentPageOffset1 = examplePokemon1.length - 1;}

        clearList(document.querySelector("#example-pokemon1"));
        getMatchupData(url);
    }
    else{
        let url = POKEAPI_URL + "type/" + type2;

        generatePressed = false;
        currentPageOffset2 += limit;
        if(currentPageOffset2 >= examplePokemon2.length){currentPageOffset2 = examplePokemon2.length - 1;}

        clearList(document.querySelector("#example-pokemon2"));
        getMatchupData(url);
    }
}

//PURPOSE: parse type data and prepare to retrieve Pokémon data
//ARGUMENTS: XMLHttpRequest containing type data from api
function dataExampleLoaded(e){
    let xhr = e.target;

    let obj = JSON.parse(xhr.responseText);

    //determine list to work in
    if(obj.name == type1){isType1 = true;}
    else{isType1 = false;}

    if(isType1){
        examplePokemon1 = obj.pokemon;
        resultsNum1 = examplePokemon1.length;
    }
    else{
        examplePokemon2 = obj.pokemon;
        resultsNum2 = examplePokemon2.length;
    }

    limit = document.querySelector("#limit").value;
    limit = parseInt(limit);

    //update to searching status and search for requested type pokémon
    if(isType1){
        document.querySelector("#examples-status1").innerHTML = `<b>Searching for ${capitalize(type1)} type Pokémon...</b>`;

        //randomize offset if this is generated by clicking generate button
        if(generatePressed){currentPageOffset1 = Math.floor(Math.random() * (resultsNum1 / limit));}

        //example Pokémon has just pokémon name and url
        //find Pokémon with another request
        for(let i = currentPageOffset1; i < currentPageOffset1 + limit; i++){
            if(i < resultsNum1){
            getPokemonData(examplePokemon1[i].pokemon.url);
            }
        }

        //update to found status
        let prevButton = document.querySelector("#previous-examples1");
        let nextButton = document.querySelector("#next-examples1");
        activateButtons(prevButton, nextButton, currentPageOffset1, resultsNum1);
        document.querySelector("#examples-status1").innerHTML = 
            `<b>${resultsNum1} results found for ${capitalize(type1)} type Pokémon:</b>`
    }
    else{
        document.querySelector("#examples-status2").innerHTML = `<b>Searching for ${capitalize(type2)} type Pokémon...</b>`;

        if(generatePressed){currentPageOffset2 = Math.floor(Math.random() * (resultsNum2 / limit));}

        for(let i = currentPageOffset2; i < currentPageOffset2 + limit; i++){
            if(i < resultsNum2){
            getPokemonData(examplePokemon2[i].pokemon.url);
            }
        }

        let prevButton = document.querySelector("#previous-examples2");
        let nextButton = document.querySelector("#next-examples2");
        activateButtons(prevButton, nextButton, currentPageOffset2, resultsNum2);
        document.querySelector("#examples-status2").innerHTML = 
            `<b>${resultsNum2} results found for ${capitalize(type2)} type Pokémon:</b>`
    }
}

//PURPOSE: retrieve Pokémon data from the given url
//ARGUMENTS: url to retrieve data from
function getPokemonData(url){
    let xhr = new XMLHttpRequest();

    xhr.onload = pokemonDataLoaded;
    xhr.onerror = pokemonDataError;

    xhr.open("GET", url);
    xhr.send();
}

//PURPOSE: creates the example Pokémon list(s)
// ARGUMENTS: an XMLHttpRequest containing Pokémon data from the api
function pokemonDataLoaded(e){
    let xhr = e.target;
    let obj = JSON.parse(xhr.responseText);
    let pokemonName = capitalize(obj.name);

    //certain forms go above max pokédex number
    let dexNumber = 0;
    if(obj.id < 899){dexNumber = obj.id;}
    else{dexNumber = "???";}

    let pokemonSprite ="";
    if(!obj.sprites.front_default){console.log("Could not retrieve sprite data");}
    else{pokemonSprite = obj.sprites.front_default;}

    //show both types (if applicable)
    let type = "";
    for(let i = 0; i < obj.types.length; i++){
        if(obj.types.length > 1 && i == 0){
        type += capitalize(obj.types[i].type.name) + "/";
        }
        else{type += capitalize(obj.types[i].type.name);}
    }

    //make sure Pokémon is added to right list by checking if one of the Pokémon's types matches a desired type
    if(type.substring(0, type1.length).toLowerCase() == type1 || 
    type.substring(type.length - type1.length, type.length).toLowerCase() == type1){
        isType1 = true;
    }
    else{isType1 = false;}

    //make div to show example
    let newDiv = document.createElement("div");
    newDiv.innerHTML = `<p id="${dexNumber}" class="name">#${dexNumber} ${pokemonName}</p>
                        <img src="${pokemonSprite}" alt="${pokemonName} Image" class="image">
                        <p class="typing">${type}</p>`;
    //newDiv.style.border = "solid 1px black";
    newDiv.style.order = dexNumber;
    newDiv.className = "example";

    //add new div to proper list, make sure list 1 isn't full just in case of overlapping types (ex: normal-flying)
    let exampleList = null;
    if(isType1 && document.querySelector("#example-pokemon1").childElementCount < limit){
        exampleList = document.querySelector("#example-pokemon1");
        exampleList.appendChild(newDiv);
    }
    else{
        if(document.querySelector("#example-pokemon2").childElementCount < limit){
            exampleList = document.querySelector("#example-pokemon2")
            exampleList.appendChild(newDiv);
        }
    }
}

//PURPOSE: print an error message if there is a problem returning Pokémon data from the api
//ARGUMENTS: the XMLHttpRequest that sent the error
function pokemonDataError(e){
    console.log("There was an error retrieving data for a Pokémon!")
}

//PURPOSE: activate and deactivate next and previous buttons for example Pokémon
//ARGUMENTS: the previous button node, the next button node, amount of offset from first page of Pokémon, number of search results
function activateButtons(prevButton, nextButton, offset, resultsNum){
    //previous button can turn off/on if a different page is being displayed
    if(offset == 0){prevButton.disabled = true;}
    else{prevButton.disabled = false;}

    //next button can turn off/on if the user is on the last page
    if(offset + limit >= resultsNum){nextButton.disabled = true;}
    else{nextButton.disabled = false;}
}
